---
title: "scrape_partyinfos"
author: "Stefan Haußner"
date: "3 3 2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(rvest)
```

# Infos from EuropeElects.eu (maybe we should ask them at some point)

# Functions

```{r}
f_inforaw <- function(html_partyblock){
  info_raw <- html_partyblock %>% 
    html_nodes("p") %>% 
    as.character() %>% 
    as_tibble_col(column_name = "text") %>% 
    separate(text, sep = "<br>", into = c("s1","s2","s3","s4","s5","s6","s7","s8")) %>% 
    filter(s2 != "") %>% 
    select(s1:s6)
  return(info_raw)
}
```

Zum Teil werden hier wegen mehrfacher "<strong>"-Klammerung im HTML-Code Parteien gedoppelt. Beim Namen wird deshalb nochmal extra alle verbleibenden strongs gelöscht und nur das erste Element ausgewählt.

```{r}
f_cleaninfo <- function(rawinfo){
  name <- rawinfo$s1 %>% read_html() %>% 
    html_nodes("strong") %>% 
    as.character() %>% 
    str_remove_all(pattern = "<[\\/]*strong>") %>% 
    .[1]
  
  abbr <- rawinfo$s1 %>% 
    str_remove_all(pattern = "<[\\/]*strong>") %>% 
    str_extract(pattern = "\\(.[^\\)]+\\)[:blank:]*$") %>% 
    str_remove(pattern = "[:blank:]$") %>%
    str_remove_all(pattern = "[\\(\\)]")

  name_en <- rawinfo$s2

  leader <- rawinfo$s3 %>% 
    str_remove(pattern = "<strong>Leader:</strong> ")

  orientation <- rawinfo$s4 %>% 
    str_remove(pattern = "<strong>Orientation:</strong> ")
  
  ep_affiliation <- rawinfo$s5 %>% 
    read_html() %>% 
    html_text() %>% 
    str_remove_all(pattern = "EP Affiliation: ") %>% 
    str_remove(pattern = " \\(.+\\)")

  eu_stance <- rawinfo$s6 %>% 
    read_html() %>% 
    html_text() %>% 
    str_remove("EU Stance:[:blank:]*") %>% 
    str_remove(" \\(Chapel Hill data\\) ")
  
  cleaninfo <- bind_cols(name = name, 
            abbr = abbr, 
            name_en = name_en, 
            leader = leader, 
            orientation = orientation, 
            ep_affiliation = ep_affiliation, 
            eu_stance = eu_stance)
  
  return(cleaninfo)
}
```

```{r}
f_countryparties <- function(url){
  html <- read_html(url)
  cntry <- html %>% html_nodes(".entry-title") %>% html_text()
  print(cntry)
  countryparties <- html %>% 
    html_nodes(".wp-block-media-text__content") %>% 
    map(f_inforaw) %>% 
    map_dfr(f_cleaninfo) %>% 
    mutate(cntry = cntry)
  return(countryparties)
}
```


# Apply


Theoretisch über die Seite direkt und read_html. Das wirft aber aus unerfindlichen Gründen bei manchen Ländern (auch immer wieder anderen) Fehler.

```{r}
country_urls <- read_html("https://europeelects.eu/") %>% 
  html_nodes(".custom-menu-class") %>% 
  html_nodes("li") %>%
  html_nodes("a") %>% 
  html_attr("href") %>% 
  .[c(5,10:17,19:21,23,24,26,28:30,34,37:39,43:46)]
```

Daher lokal source-codes abgespeichert und hier geladen.

Probleme bei Belgien (klaro), Irland

Special Cases: Bulgaria, weil dort ein kyrillisches Schriftset genutzt wird. Die zweite Zeile ist dann nicht die englische Bezeichnung, sondern die "arabischer Schriftsatz" während die dritte Zeile erst die englische Übersetzung ist.

```{r}
partyinfos <- list.files(path = "../data/sourcecode_ee/", pattern = "source_") %>% 
  paste0("../data/sourcecode_ee/",.) %>% 
  .[-c(2,15)] %>% 
  map_dfr(f_countryparties)
partyinfos
```




```{r}
t <- read_html("../misc/test_estonia_sourcehtml.txt")

read_html("https://europeelects.eu/france/")

partyinfo_raw <- read_html("https://europeelects.eu/estonia/") %>% 
  html_nodes(".wp-block-media-text__content") %>% 
  html_nodes("p") %>% 
  as.character() %>% 
  as_tibble_col(column_name = "text") %>% 
  separate(text, sep = "<br>", into = c("s1","s2","s3","s4","s5","s6","s7","s8")) %>% 
  select(s1:s6)
```

```{r}
partyinfo_raw$s1 %>% read_html() %>% html_nodes("strong") %>% as.character() %>% str_remove_all(pattern = "<[\\/]*strong>") %>% .[1]

partyinfo_raw$s1 %>% 
  str_remove_all(pattern = "<[\\/]*strong>") %>% 
  str_extract(pattern = "\\(.[^\\)]+\\)[:blank:]*$") %>% 
  str_remove(pattern = "[:blank:]$") %>%
  str_remove_all(pattern = "[\\(\\)]")

partyinfo_raw$s2

partyinfo_raw$s3 %>% 
  str_remove(pattern = "<strong>Leader:</strong> ")

partyinfo_raw$s4 %>% 
  str_remove(pattern = "<strong>Orientation:</strong> ")

partyinfo_raw$s5 %>% 
  read_html() %>% 
  html_text() %>% 
  str_remove_all(pattern = "EP Affiliation: ") %>% 
  str_remove(pattern = " \\(.+\\)")

partyinfo_raw$s6 %>% 
  read_html() %>% 
  html_text() %>% 
  str_remove("EU Stance:[:blank:]*") %>% 
  str_remove(" \\(Chapel Hill data\\) ")

bind_cols(name = name, abbr = abbr, name_en = name_en, leader = leader, orientation = orientation, ep_affiliation = ep_affiliation, eu_stance = eu_stance)

```


